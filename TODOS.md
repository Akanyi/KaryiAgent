### **KaryiAgent: 综合功能清单**

#### **核心交互模型 (Core Interaction Model)** 

*   **统一 TUI 入口**:
    *   通过单一 `karyi` 命令进入一个全屏、持久化、有状态的终端对话界面 (TUI)。
*   **结构化 AI 响应**:
    *   AI 与系统的通信协议为严格的 JSON 格式 `{ "reply": "...", "tools": "..." }`，将 AI 的“思考”（自然语言回复）与“行动”（工具调用）彻底分离。
*   **富文本终端输出**:
    *   AI 的 `reply` 支持 Markdown，并会渲染成美观、带格式的终端文本。
*   **统一工具协议 (XML)**:
    *   所有 AI 的“行动”都通过一个统一、强类型的 XML 格式来定义，无论是内置功能还是外部扩展。

---

#### **会话管理与控制 (Session Management & Control)**

*   **“会-话中心” (`Ctrl+C` 拦截)**:
    *   `Ctrl+C` 不再是退出，而是进入一个“暂停与审查”的仪表盘。
    *   **会话透明度**: 在会话中心清晰展示：
        *   会话时长、LLM Token 消耗、对话轮数。
        *   本会话中被 AI 修改过的文件列表。
        *   本会话中新交付或使用的安全变量列表。
    *   **用户终极控制权**: 在会话中心提供多种操作：
        *   **(R)esume**: 无缝返回对话。
        *   **(Q)uit / 第二次 `Ctrl+C`**: 确认并退出应用。
*   **交互式 Shell 控制**:
    *   **会话级伪终端 (PTY)**: 每个会话拥有一个独立的、持久化的 shell 环境，确保了 AI 操作和用户接管之间的上下文连续性。
    *   **用户接管 Shell (`Takeover`)**: 允许用户在会话中心完全接管 AI 所在的 shell 环境，进行手动调试或干预。
    *   **临时命令执行 (`!`)**: 允许用户在会话中心执行一次性的 shell 命令来快速检查状态，而不中断暂停状态。
*   **工业级返回机制**:
    *   提供全局可用的 `karyi-back` 命令。
    *   通过向 PTY 注入环境变量 (`KARYI_IPC_PATH`) 和使用跨平台的本地 IPC (命名管道/UDS) 与主进程通信，实现从接管的 shell 中安全、可靠地返回会-话中心。

---

#### **安全、审计与恢复 (Safety, Auditing & Recovery)**

*   **零知识安全变量**:
    *   AI 只能通过 `$KARYI{VAR_NAME}` 占位符引用敏感变量，永远无法接触真实值。
*   **AI 主动变量请求**:
    *   AI 使用 `<get_value>` 元工具，携带 `reason` 和 `note` 来明确请求它完成任务所需的凭证。
*   **按需交互式变量交付**:
    *   当 AI 请求一个未定义的变量时，系统会暂停任务，并安全地提示用户输入。
    *   用户可以选择将变量仅用于当-前会话，或永久保存到操作系统的安全凭证管理器中。
*   **可配置的安全行为**:
    *   用户可以通过 `karyi config` 将变量交付模式从默认的 `interactive` 切换为 `warn` 模式。
*   **“影子仓库”审计系统**:
    *   AI 的每一次文件修改都会被自动提交到一个独立的、位于 `.karyi/history/` 的 Git 仓库中。
    *   **不污染用户仓库**: 完全隔离 AI 的操作历史，不影响用户自己的 Git 工作流。
    *   **结构化提交信息**: 每次提交都包含丰富的元数据（会话 ID、用户提示、工具 XML），便于审计。
    *   **稀疏与高效**: 通过使用**符号链接 (Symbolic Links)** 来镜像未修改的文件，极大地降低了影子仓库在大型项目中的磁盘空间和性能开销。
    *   **`karyi history` 命令**: 提供一个友好的命令行接口来查看、审查和回滚 AI 的文件修改历史。
*   **“保险箱”机制**:
    *   对数据库文件 (`*.db`)、环境-配置文件 (`.env`) 等高风险文件进行破坏性操作时，系统会自动拦截并创建带时间戳的备份。
    *   **主动警告**: 在下一次会话启动时，系统会以醒目的红色横幅提示用户 AI 在之前执行了高风险操作。

---

#### **项目理解与智能 (Project Comprehension & Intelligence)**

*   **主动风险扫描**:
    *   在首次进入项目时或通过 `karyi scan` 命令，自动扫描项目以识别潜在的风险文件（配置文件、密钥、二进制文件等）。
    *   生成一份人类可读的**注意事项文件 (`.karyi/precautions.md`)**，并提示用户查阅。
*   **技术栈与命令清单生成器**:
    *   同样通过扫描，分析 `package.json`, `Makefile`, `pyproject.toml` 等配置文件。
    *   生成一份结构化的**项目清单文件 (`.karyi/manifest.json`)**，包含：
        *   **识别出的技术栈**: (Node.js, React, Python, Django 等)。
        *   **可用的项目命令**: (如 `npm run build`, `make test` 等)。
*   **AI 上下文注入**:
    *   将“注意事项”和“项目清单”的摘要信息在每次会话开始时注入到 AI 的 System Prompt 中。
*   **AI 行为进化**:
    *   使 AI 从一个通用的命令行工具，进化为一个**了解当前项目技术栈、熟悉其专用命令、并知晓其操作“雷区”的领域专家**，从而做出更智能、更安全、更高效的决策。